<!--
    Copyright (c) 2017, Randy Westlund. All rights reserved.
    This code is under the BSD-2-Clause license.
-->
<!--
    This module contains all the application's forms. They are triggered
     with signals. This is a workaround for:
     https://github.com/PolymerElements/iron-overlay-behavior/issues/208#issuecomment-234024428
-->

<link rel="import" href="../bc/polymer/polymer.html">

<link rel="import" href="global-behavior.html">
<link rel="import" href="recipe-form.html">
<link rel="import" href="linked-recipe-form.html">
<link rel="import" href="ingredients-form.html">
<link rel="import" href="directions-form.html">
<link rel="import" href="user-form.html">
<link rel="import" href="recipe-info-form.html">

<dom-module id="recipe-forms">
    <template>
        <template is="dom-if" if="[[is_user(userRole)]]">
            <recipe-form id="create_recipe_form" title="Create Recipe">
            </recipe-form>
            <recipe-form id="edit_recipe_form"></recipe-form>
            <ingredients-form id="edit_ingredients_form"></ingredients-form>
            <directions-form id="edit_directions_form"></directions-form>
            <recipe-info-form id="edit_recipe_info_form"></recipe-info-form>
            <linked-recipe-form id="edit_linked_recipe_form">
            </linked-recipe-form>
        </template>

        <template is="dom-if" if="[[is_admin(userRole)]]">
            <user-form id="create_user_form" title="Create User"></user-form>
            <user-form id="edit_user_form"></user-form>
        </template>
    </template>

    <script>
        (function() {
            'use strict';
            Polymer({
                is: "recipe-forms",
                behaviors: [ recipe_behaviors.global_behavior ],
                properties: {
                    // Passed in by the parent to conditionally render forms.
                    userRole: {
                        type: String,
                    },
                    // A reference to the element that asked to open a form.
                    dialog_parent: {
                        type: Object,
                        value: null,
                    },
                    // The name of the callback function on the requesting
                    // element.
                    dialog_callback: {
                        type: String,
                    },
                },
                listeners: {
                    // Every form fires a "closed" event. Rather than binding
                    // a listener to each one, let it bubble up and catch them
                    // all here.
                    "closed": "dialog_closed",
                },
                attached: function() {
                    // Listen for requests to open forms.
                    this._listener = this.open_form.bind(this);
                    window.addEventListener("open-form", this._listener);
                },
                // Remove listeners to avoid memory leaks.
                detached: function() {
                    window.removeEventListener("open-form", this._listener);
                },
                // On close, notify the element that asked for the form.
                dialog_closed: function(e, reason) {
                    if (this.dialog_parent)
                        this.dialog_parent[this.dialog_callback](e, reason);
                },
                // Open whichever form was requested by the signal.
                open_form: function(e) {
                    // Save a reference to the element that sent the request so
                    // we can tell it when the form closes.
                    this.dialog_parent = e.detail.that;
                    // If the sender requests a special callback, use it.
                    // Otherwise, use "resolve_dialog".
                    this.dialog_callback = e.detail.callback ? e.detail.callback :
                            "resolve_dialog";
                    // If any of these properties are given from the signal,
                    // assign them to the form. This prevents needing a large
                    // switch to set up each form.
                    var props = [ "recipe", "user" ];
                    props.forEach(p => {
                        if (e.detail[p])
                            this.$$("#" + [e.detail.name])[p] = e.detail[p];
                    });
                    this.$$("#" + [e.detail.name]).open();
                },
            });
        })();
    </script>
</dom-module>
