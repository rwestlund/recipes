<!--
    Randy Westlund
    2016-04
-->
<!-- this module shows a list of users -->

<link rel="import" href="../bc/polymer/polymer.html">

<!-- External styles for this element -->
<link rel="import" href="../styles/user-collection-style.html">

<dom-module id="user-collection">
    <template>
        <!-- Include the external styles for this element -->
        <style is="custom-style" include="user-collection-style"></style>
        <style>
            :host {
                display: block;
                /*margin: 5px;*/
            }
            #filterInputField {
                width 200px;
                float: right;
            }
            .page-title-text {
                font-size: 2em;
                color: #AAA;
            }
            .user-title {
                font-style: italic;
                font-weight: normal;
                margin-bottom: 0;
                margin-top: 0;
            }
            paper-fab {
                --paper-fab-keyboard-focus-background: #E9E9E9;
            }
            td.td-label {
                font-weight: bold;
                text-align: right;
                padding-right: 0.8em;
            }
        </style>

        <!-- AJAX elements -->
        <iron-ajax auto
                method="GET"
                url="/users"
                params="{{usersFilter}}"
                handle-as="json"
                last-response="{{users}}"
                debounce-duration="100"
                on-error="onAjaxError"
                loading="{{loading.getUsers}}">
        </iron-ajax>
        <iron-ajax id="postNewUser"
                method="POST"
                url="/users"
                body="{{ajaxData}}"
                content-type="application/json"
                handle-as="json"
                last-response="{{lastUserCreated}}"
                on-error="createUserFailed"
                on-response="userCreated"
                loading="{{loading.postUser}}">
        </iron-ajax>
        <iron-ajax id="putNewUser"
                method="PUT"
                url="/users"
                body="{{ajaxData}}"
                content-type="application/json"
                handle-as="json"
                last-response="{{lastUserCreated}}"
                on-error="saveUserFailed"
                on-response="userSaved"
                loading="{{loading.putUser}}">
        </iron-ajax>

        <!-- a filter box -->
        <div class="layout horizontal center end-justified mv-lg">
            <div class="flex self-start page-title-text">Users</div>
            <paper-spinner class="nav-button" active="{{loadingData}}"
                    alt="loading users...">
            </paper-spinner>
            <paper-input label="Filter" type="text" maxlength="60"
                    value="{{userNameFilter}}">
            </paper-input>

            <paper-fab mini
                icon="social:person-add"
                on-tap="openEditUserDialog"
                title="add user"
                class="add-user-button pull-right ml-lg mt-lg">
            </paper-fab>
        </div>

        <!-- Each user card. -->
        <template is="dom-repeat" items={{users}} as="user">
            <paper-material>
                <div class="item">
                    <div class="layout horizontal center justified">
                        <h3 class="user-title">{{user.name}}</h3>
                        <div>
                            <paper-icon-button
                                    icon="icons:create"
                                    on-tap="openEditUserDialog"
                                    data-id$="{{user.id}}">
                            </paper-icon-button>
                            <paper-icon-button
                                    icon="icons:delete"
                                    on-tap="deleteUserClick"
                                    data-id$="{{user.id}}">
                            </paper-icon-button>
                        </div>
                    </div>
                    <div class="layout horizontal center-justified">
                        <span class="flex-1"></span>
                        <div class="flex-11 layout vertical">
                            <table>
                                <tr>
                                    <td class="td-label">Email</td>
                                    <td>{{user.email}}</td>
                                </tr>
                                <tr>
                                    <td class="td-label">Role</td>
                                    <td>{{user.role}}</td>
                                </tr>
                                <tr>
                                    <td class="td-label">Last Login</td>
                                    <td>{{toDateStringPretty(user.lastlog)}}</td>
                                </tr>
                                <tr>
                                    <td class="td-label">Created</td>
                                    <td>{{toDateStringPretty(user.date_created)}}</td>
                                </tr>
                                <tr>
                                    <td class="td-label">Recipes</td>
                                    <td>{{user.recipes_authored}}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </paper-material>
        </template>

        <!-- Dialogs -->

        <paper-dialog with-backdrop no-cancel-on-outside-click
                id="deleteUserConfirmationDialog">
            <h2>Delete User</h2>
            <p>
                Are you sure you want to delete {{userToDelete.role}}
                <strong>{{userToDelete.name}}</strong>?
            </p>

            <div class="buttons">
                <paper-button dialog-dismiss>Cancel</paper-button>
                <paper-button dialog-confirm on-tap="deleteUserConfirmClick">
                    Delete
                </paper-button>
            </div>
        </paper-dialog>

        <!-- For editing user details. -->
        <paper-dialog with-backdrop no-cancel-on-outside-click
                id="editUserDialog">
            <h2>
                <template is="dom-if" if="{{newUser}}">Add</template>
                <template is="dom-if" if="{{!newUser}}">Edit</template>
                User
            </h2>
            <div class="layout horizontal justified">
                <div class="flex-11">
                    <paper-dropdown-menu label="Account Role">
                        <paper-menu id="accountRoleSelectMenu"
                                class="dropdown-content"
                                attr-for-selected="value"
                                selected="{{ajaxData.role}}">
                            <paper-item value="admin">Admin</paper-item>
                            <paper-item value="moderator">Moderator</paper-item>
                            <paper-item value="user">User</paper-item>
                        </paper-menu>
                    </paper-dropdown-menu>
                    <paper-input id="userEmailAddress" value="{{ajaxData.email}}"
                        label="Email" maxlength="40">
                    </paper-input>
                </div>
                <!-- This span makes sure the dropdown has enough space. -->
                <span class="flex-1"></span>
            </div>
            <div class="buttons">
                <paper-button dialog-dismiss>Cancel</paper-button>
                <paper-button dialog-confirm on-tap="createUserClick"
                        hidden="[[!newUser]]">
                    Add
                </paper-button>
                <paper-button dialog-confirm on-tap="saveUserClick"
                        hidden="[[newUser]]">
                    Save
                </paper-button>
            </div>
        </paper-dialog>

        <!-- Notifications used by iron-ajax handlers. -->
        <paper-toast
                id="successToast"
                class="success-toast"
                text="{{toastMessage}}"
                duration="4000">
        </paper-toast>
        <paper-toast
                id="errorToast"
                class="error-toast"
                text="{{toastMessage}}"
                duration="4000">
        </paper-toast>

    </template>

    <script>
        (function () {
            'use strict';
            Polymer({
                is: 'user-collection',
                properties: {
                    users: {
                        type: Object,
                    },
                    // Query params for GET /users.
                    usersFilter: {
                        type: String,
                        computed: "computeUsersFilter(userNameFilter)",
                    },
                    // Filter box value.
                    userNameFilter: {
                        type: String,
                        value: "",
                    },
                    // Body for POST and PUT /users.
                    ajaxData: {
                        type: Object,
                    },
                    lastUserCreated: {
                        type: Object,
                    },
                    /* One flag for each iron-ajax. */
                    loading: {
                        type: Object,
                        value: {
                            getUsers: false,
                            putUser: false,
                            postUser: false,
                        },
                    },
                    // True whenever we're loading XHR data.
                    loadingData: {
                        type: Boolean,
                        computed: "computeLoadingData(loading.*)",
                    },
                    // Set by iron-ajax handlers prior to flashing toast.
                    toastMessage: {
                        type: String,
                    },
                },
                ready: function () {
                },
                computeUsersFilter: function(userNameFilter) {
                    var o = {};
                    if (userNameFilter) o.name_or_email = userNameFilter;
                    return o;
                },
                /* Loading is true if any flags in it are true. */
                computeLoadingData: function(loading) {
                    var ret = false;
                    Object.keys(this.loading)
                        .forEach( v => ret = ret || this.loading[v] );
                    return ret;
                },
                // Called upon submission of new user form.
                createUserClick: function () {
                    this.$.postNewUser.generateRequest()
                },
                // Called when a POST /users succeeds.
                userCreated: function() {
                    this.toastMessage = "New " +
                            this.lastUserCreated.role + " " +
                            this.lastUserCreated.email + " created";
                    // Rather than refetch users, just append the new one.
                    this.push("users", this.lastUserCreated);
                    this.$.successToast.open();
                },
                // Called when a POST /users fails.
                createUserFailed: function(e, s) {
                    // failure status is here:
                    //console.log(e.detail.request.status);
                    this.toastMessage = "Failed to create user :(";
                    this.$.errorToast.open();
                },

                // Called when a PUT /users succeeds.
                userSaved: function() {
                    this.toastMessage =
                            this.lastUserCreated.role + " " +
                            this.lastUserCreated.email + " saved";

                    /* Update user in our list. */
                    var that = this;
                    for(var i = 0; i < that.users.length; i++) {
                        if(that.users[i].id === that.lastUserCreated.id) {
                            that.splice('users', i, 1, that.lastUserCreated);
                        }
                    }
                    this.$.successToast.open();
                },
                // Called when a PUT /users fails.
                saveUserFailed: function() {
                    this.toastMessage = "Failed to save user :(";
                    this.$.errorToast.open();
                },


                // UTILITY FUNCTIONS
                toDateStringPretty: function (timestamp) {
                    if(timestamp) {
                        var date = new Date(timestamp)
                        return date.toDateString() + ' ' + date.toLocaleTimeString();
                    }
                    else return '(no activity recorded)';
                },

                openEditUserDialog: function() {

                    var currentTarget = e.currentTarget;
                    var idAttr = currentTarget.attributes['data-id'];
                    var id;
                    if(idAttr) id = Number(idAttr.value);

                    // if we are editing an existing user
                    if(id) {
                        var that = this;
                        this.users.forEach(function(user) {
                            if(id === user.id) that.ajaxData = user;
                        });
                        this.set('newUser', false);
                    }
                    // otherwise initialize form with defaults
                    else {
                        this.ajaxData = { email: "", role: "user" };
                        this.set('newUser', true);
                    }
                    this.$.editUserDialog.open();
                },

                // Called upon submission of edit user form.
                saveUserClick: function () {
                    var that = this;
                    this.$.putNewUser.generateRequest()
                },

                deleteUserClick: function (e) {
                    // prohibit containing div from firing its on-tap handler
                    e.stopPropagation();

                    var currentTarget = e.currentTarget;
                    var id = Number(currentTarget.attributes['data-id'].value);

                    if (id) {
                        var userToDelete;
                        this.users.forEach(function(user) {
                            if (id === user.id) userToDelete = user;
                        });
                        this.set('userToDelete', userToDelete);
                    }
                    this.$.deleteUserConfirmationDialog.open();
                },

                deleteUserConfirmClick: function () {

                    this.set('progressActive', true);

                    var that = this;
                    this.deleteUser(this.userToDelete.id)
                        .then(function() {
                            // remove from users list
                            for(var i = 0; i < that.users.length; i++) {
                                if(that.users[i].id === that.userToDelete.id) {
                                    that.splice('users', i, 1);
                                }
                            }
                            // notify success
                            that.set('successMessage', 'User deleted');
                            that.$.userSuccess.open();
                            that.set('progressActive', false);
                        }, function (err) {
                            // notify error
                            that.set('errorMessage', 'Error deleting user');
                            that.$.userError.open();
                            that.set('progressActive', false);
                        });
                },
            });
        })();
    </script>
</dom-module>
