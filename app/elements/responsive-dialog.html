<!--
    Randy Westlund
    2016-04
-->
<!-- This module displays a modal fullscreen on mobile and smaller on desktop.
-->

<link rel="import" href="../bc/polymer/polymer.html">
<link rel="import" href="../bc/paper-styles/paper-styles.html">
<link rel="import" href="../bc/paper-dialog-behavior/paper-dialog-behavior.html">
<link rel="import" href="../bc/paper-dialog-behavior/paper-dialog-shared-styles.html">
<link rel="import" href="../bc/neon-animation/neon-animation-runner-behavior.html">

<dom-module id="responsive-dialog">
    <template>
        <style>
            :host {
                display: none;
            }
            :host([opened]) {
                display: block;
            }
            :host([mobile]) {
                position: fixed;
                left: 0;
                right: 0;
                top: 0;
                bottom: 0;
                z-index: 103;
                background-color: var(--primary-background-color);
            }
            div.fullscreen-column {
                padding-left: 1em;
                padding-right: 1em;
                padding-bottom: 2em;
            }
            paper-dialog-scrollable {
                margin-top: 0em;
            }
        </style>

        <iron-media-query query="(max-width: [[responsiveWidth]])"
                query-matches="{{mobile}}">
        </iron-media-query>

        <!-- This normal paper-dialog is used on desktop. -->
        <template is="dom-if" if="[[!mobile]]">
            <paper-dialog id="dialog"
                    on-iron-overlay-closed="modal_closed"
                    with-backdrop no-cancel-on-outside-click>
                <h2>[[title]]</h2>
                <paper-dialog-scrollable>
                    <content select="*"></content>
                </paper-dialog-scrollable>
                <div class="buttons">
                    <template is="dom-if" if="[[dismissText]]">
                        <paper-button dialog-dismiss>
                            [[dismissText]]
                        </paper-button>
                    </template>
                    <template is="dom-if" if="[[confirmText]]">
                        <paper-button dialog-confirm>
                            [[confirmText]]
                        </paper-button>
                    </template>
                </div>
            </paper-dialog>
        </template>

        <!-- This custom fullscreen dialog is used on mobile. -->
        <template is="dom-if" if="[[mobile]]">
            <paper-header-panel>
                <paper-toolbar>
                    <paper-icon-button icon="[[get_icon()]]" on-tap="dismiss">
                    </paper-icon-button>
                    <span class="title">[[title]]</span>
                    <!-- If there's no dismissText, then we're just showing a
                         back arrow. -->
                    <template is="dom-if" if="[[dismissText]]">
                        <paper-button dialog-confirm on-tap="confirm">
                            [[confirmText]]
                        </paper-button>
                    </template>
                </paper-toolbar>

                <div class="fullscreen-column">
                    <content select="*"></content>
                    <br />
                    <br />
                </div>
            </paper-header-panel>
        </template>

        <!-- TODO after opening the dialog on a large screen, it will not open
             on a small one. I belive this is because the <content> in the first
             block gobbles up the light DOM and doesn't give it back when it is
             removed. -->

        <!-- TODO this dialog should capture and close on back arrow. -->


    </template>
</dom-module>

<script>
    (function () {
        'use strict';
        Polymer({
            is: 'responsive-dialog',
            behaviors: [],
            properties: {
                // Anything smaller than this is mobile.
                responsiveWidth: {
                    type: String,
                    value: '600px'
                },
                mobile: {
                    type: Boolean,
                    value: false,
                    reflectToAttribute: true,
                },
                opened: {
                    type: Boolean,
                    value: false,
                    reflectToAttribute: true,
                },
                dismissText: {
                    type: String,
                    value: "",
                },
                confirmText: {
                    type: String,
                    value: "",
                },
            },
            open: function() {
                this.opened = true;
                if (!this.mobile) this.$$('#dialog').open();
            },
            close: function() {
                if (!this.mobile) this.$$('#dialog').close();
                else this.dismiss();
            },
            dismiss: function(e) {
                //TODO this top still highlights the menu icon behind it :/
                e.stopPropagation();
                this.opened = false;
                this.fire('iron-overlay-closed', { canceled: true });
            },
            confirm: function() {
                this.opened = false;
                this.fire('iron-overlay-closed', { confirmed: true });
            },
            modal_closed: function(e, reason) {
                // HACK: The paper-dropdown-menu element implements
                // iron-overlay-bahavior, which means that is fires
                // iron-overlay-closed, which bubbles all the way up here and
                // closes the dialog. This should be fixed in a future version
                // of Polymer. See:
                // https://github.com/PolymerElements/iron-overlay-behavior/issues/70
                // https://github.com/PolymerElements/paper-dropdown-menu/issues/87

                // Stop this event regardless of which one it is.
                e.stopPropagation();

                // If it's from the paper-menu-button problem, ignore it.
                if (e.target !== this.$$('#dialog')) {
                    return;
                }

                // Send our real one.
                this.opened = false;
                this.fire('iron-overlay-closed', reason);
            },
            // If no dismissText, use <- rather than X.
            get_icon: function() {
                if (this.dismissText) return "icons:close";
                return "icons:arrow-back";
            },
        });
    })();
</script>
