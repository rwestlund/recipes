<!--
    Randy Westlund
    2016-04
-->
<!-- This module allows editing of a recipe. -->

<link rel="import" href="../bc/polymer/polymer.html">

<dom-module id="recipe-details">
    <template>
        <style is="custom-style" include="global-styles"></style>
        <style>
            :host {
                display: block;
            }
        </style>

        <!-- AJAX requests. -->
        <iron-ajax auto="[[recipeId]]"
                method="GET"
                url="/recipes/[[recipeId]]"
                handle-as="json"
                last-response="{{recipe}}"
                on-error="loading_recipe_failed"
                on-response="recipe_received"
                loading="{{loading.get_recipe}}">
        </iron-ajax>
        <iron-ajax method="PUT"
                id="put_item_ajax"
                url="/recipes/[[recipeId]]"
                body="[[recipe]]"
                content-type="application/json"
                handle-as="json"
                last-response="{{new_recipe}}"
                on-response="put_item_successful"
                on-error="put_item_failed"
                loading="{{loading.put_item}}">
        </iron-ajax>

        <div class="headerbar layout horizontal center">
            <paper-button raised on-tap="load_recipes_page">
                <iron-icon icon="icons:arrow-back"></iron-icon>
                All Recipes
            </paper-button>
            <paper-button raised on-tap="toggle_edit_mode">
                <iron-icon icon="icons:create"></iron-icon>
                <template is="dom-if" if="[[editMode]]">
                    Leave
                </template>
                <template is="dom-if" if="[[!editMode]]">
                    Enter
                </template>
                Edit Mode
            </paper-button>
            <paper-spinner class="nav-button" active="[[loadingData]]"
                    alt="loading recipes...">
            </paper-spinner>
        </div>

        <!-- The recipe card itself. --> 
        <paper-material>
            <div class="card-item">
                <!-- Form version. -->
                <template is="dom-if" if="[[editMode]]">
                    <div class="layout horizontal wrap">
                        <div class="flex-4 item-col">
                            <paper-input type="text"
                                    label="Title"
                                    value="{{recipe.title}}">
                            </paper-input>
                            <paper-textarea type="text"
                                    label="Summary"
                                    value="{{recipe.summary}}">
                            </paper-textarea>

                            <!-- Ingredients inputs. -->
                            <strong class="recipe-item-label">
                                Ingredients
                            </strong>
                            <template is="dom-repeat"
                                    items="{{recipe.ingredients}}" as="i">
                                <paper-input type="text"
                                        label="Item [[add_one(index)]]"
                                        value="{{i}}">
                                    <paper-icon-button suffix
                                            icon="icons:cancel"
                                            data-index$="[[index]]"
                                            on-tap="delete_ingredient">
                                    </paper-icon-button>
                                    <paper-icon-button suffix
                                            icon="icons:arrow-upward"
                                            data-index$="[[index]]"
                                            disabled$="[[!index]]"
                                            on-tap="move_ingredient_up">
                                    </paper-icon-button>
                                </paper-input>
                            </template>

                            <div class="layout horizontal center-justified">
                                <paper-button on-tap="add_ingredient">
                                    <iron-icon icon="icons:add-circle">
                                    </iron-icon>
                                    Add item
                                </paper-button>
                            </div>
                        </div>

                        <div class="flex-4 item-col">
                            <!-- Directions inputs. -->
                            <strong class="recipe-item-label">
                                Directions
                            </strong>
                            <template is="dom-repeat"
                                    items="{{recipe.directions}}" as="d">
                                <paper-textarea type="text"
                                        label="Step [[add_one(index)]]"
                                        value="{{d}}">
                                </paper-textarea>
                                <div class="layout horizontal end-justified">
                                    <paper-button
                                            data-index$="[[index]]"
                                            on-tap="delete_direction">
                                        <iron-icon icon="icons:cancel">
                                        </iron-icon>
                                        Remove Step [[add_one(index)]]
                                    </paper-button>
                                    <paper-icon-button
                                            icon="icons:arrow-upward"
                                            data-index$="[[index]]"
                                            disabled$="[[!index]]"
                                            on-tap="move_direction_up">
                                    </paper-icon-button>
                                </div>
                            </template>
                            <div class="layout horizontal center-justified">
                                <paper-button on-tap="add_direction">
                                    <iron-icon icon="icons:add-circle">
                                    </iron-icon>
                                    Add item
                                </paper-button>
                            </div>
                        </div>
                        <div class="flex-4 item-col">
                            <paper-input type="text"
                                    label="Amount"
                                    value="{{recipe.amount}}">
                            </paper-input>
                            <paper-input type="text"
                                    label="Time"
                                    value="{{recipe.time}}">
                            </paper-input>
                            <paper-input type="text"
                                    label="Oven"
                                    value="{{recipe.oven}}">
                            </paper-input>
                            <paper-input type="text"
                                    label="Source"
                                    value="{{recipe.source}}">
                            </paper-input>
                            <paper-textarea type="text"
                                    label="Notes"
                                    value="{{recipe.notes}}">
                            </paper-textarea>
                        </div>
                    </div>
                </template>

                <!-- Display version. -->
                <template is="dom-if" if="[[!editMode]]">
                    <div class="layout horizontal end end-justified wrap">
                        <h3 class="card-title">[[recipe.title]]</h3>
                        <!--<div class="layout horizontal end-justified">-->
                            <span class="flex"></span>
                            <span class="recipe-tags">
                                [[format_recipe_tags(recipe.tags)]]
                            </span>
                        <!--</div>-->
                    </div>
                    <div>[[recipe.summary]]</div>

                    <div class="layout horizontal wrap">
                        <div class="flex-4 item-col">
                            <strong class="recipe-item-label">
                                Ingredients
                            </strong>
                            <ul class="ingredients-list">
                                <template is="dom-repeat"
                                        items="[[recipe.ingredients]]"
                                        as="i">
                                    <li>[[i]]</li>
                                </template>
                            </ul>
                        </div>
                        <div class="flex-4 item-col">
                            <strong class="recipe-item-label">
                                Directions
                            </strong>
                            <ol class="directions-list">
                                <template is="dom-repeat"
                                        items="[[recipe.directions]]"
                                        as="d">
                                    <li>[[d]]</li>
                                </template>
                            </ol>
                        </div>
                        <!-- Info column. -->
                        <div class="flex-4 item-col">
                            <template is="dom-if" if="[[recipe.amount]]">
                                <strong class="recipe-item-label">
                                    Amount
                                </strong>
                                <div>[[recipe.amount]]</div>
                            </template>
                            <template is="dom-if" if="[[recipe.time]]">
                                <strong class="recipe-item-label">Time</strong>
                                <div>[[recipe.time]]</div>
                            </template>
                            <template is="dom-if" if="[[recipe.oven]]">
                                <Strong class="recipe-item-label">Oven</Strong>
                                <div>[[recipe.oven]]</div>
                            </template>
                            <strong class="recipe-item-label">Author</strong>
                            <div>[[recipe.author_name]]</div>
                            <template is="dom-if" if="[[recipe.source]]">
                                <strong class="recipe-item-label">
                                    Source
                                </strong>
                                <div>[[recipe.source]]</div>
                            </template>
                            <strong class="recipe-item-label">Revision</strong>
                            <div>[[recipe.revision]]</div>
                            <template is="dom-if" if="[[recipe.notes]]">
                                <strong class="recipe-item-label">
                                    Notes
                                </strong>
                                <div>[[recipe.notes]]</div>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
        </paper-material>

        <paper-toast id="save_toast"
                class="warn-toast"
                duration="0"
                horizontal-align="right"
                horizontal-offset="20"
                no-cancel-on-esc-key
                on-click="save_recipe"
                text="You have unsaved changes. Click here to save.">
        </paper-toast>
    </template>

    <script>
        (function() {
            'use strict';
            Polymer({
                is: 'recipe-details',
                properties: {
                    recipeId: {
                        type: String,
                    },
                    // Holds the recipe we load in.
                    recipe: {
                        type: Object,
                    },
                    loading: {
                        type: Object,
                        value: {
                            get_recipe: false,
                            put_item:   false,
                        },
                    },
                    // True whenever we're loading XHR data.
                    loadingData: {
                        type: Boolean,
                        computed: "computeLoadingData(loading.*)",
                    },
                    // Whether to show inputs or just display.
                    editMode: {
                        type: Boolean,
                        value: false,
                    },
                },
                observers: [ "check_change(recipe.*)" ],
                ready: function() {
                },
                /* Loading is true if any flags in it are true. */
                computeLoadingData: function(loading) {
                    var ret = false;
                    Object.keys(this.loading)
                        .forEach( v => ret = ret || this.loading[v] );
                    return ret;
                },
                save_recipe: function() {
                    this.$.put_item_ajax.generateRequest();
                },
                put_item_failed: function() {
                    this.fire("iron-signal", {
                        name: "error-toast",
                        data: "Failed to save recipe :(",
                    });
                },
                put_item_successful: function() {
                    // load the response into new_recipe and copy it here to
                    // prevent blanking the screen on a failed request.
                    this.fire("iron-signal", {
                        name: "success-toast",
                        data: this.new_recipe.title + " saved",
                    });
                    this.set('recipe', this.new_recipe);
                    // Make it back up the new copy.
                    this.recipe_received();
                    // Checking for change should automatically fire.
                },
                loading_recipe_failed: function() {
                    this.fire("iron-signal", {
                        name: "error-toast",
                        data: "Failed to communicate with server :(",
                    });
                },
                /* Make a copy of the recipe so we can tell whether it changed. */
                recipe_received: function() {
                    var o = JSON.parse(JSON.stringify(this.recipe));
                    this.set('backup_recipe', o);
                },
                check_change: function() {
                    if (!this.backup_recipe) return;
                    var change = this.rdiff(this.backup_recipe, this.recipe);
                    if (change) this.$.save_toast.open();
                    else this.$.save_toast.close();
                },
                rdiff: function(a, b) {
                    /* Because null and [] are objects. */
                    if (a !== null && typeof a === "object") {
                        /* If only a is an object they're different. */
                        if (b === null || typeof b !== "object") return true;
                        // Iterate over keys, making sure everything in a
                        // exists in b. This stops recursing when we find a
                        // difference.
                        var diff = false;
                        for (var e in a) {
                            diff = diff || this.rdiff(a[e], b[e]);
                        }
                        // Now do the same for b in a.
                        for (var e in b) {
                            diff = diff || this.rdiff(a[e], b[e]);
                        }
                        return diff;
                    }
                    // Base case; a simple comparison between simple types.
                    else return a !== b;
                },
                load_recipes_page: function() {
                    page.show('/');
                },
                toggle_edit_mode: function() {
                    this.editMode = !this.editMode;
                },
                add_ingredient: function() {
                    this.push("recipe.ingredients", new String());
                },
                add_direction: function() {
                    this.push("recipe.directions", new String());
                },
                delete_ingredient: function(e) {
                    var index = Number(
                            e.currentTarget.attributes['data-index'].value);
                    this.splice('recipe.ingredients', index, 1);
                },
                delete_direction: function(e) {
                    var index = Number(
                            e.currentTarget.attributes['data-index'].value);
                    this.splice('recipe.directions', index, 1);
                },
                move_ingredient_up: function(e) {
                    var index = Number(
                            e.currentTarget.attributes['data-index'].value);
                    if (!index) return;
                    var temp = this.splice('recipe.ingredients', index, 1)[0];
                    this.splice('recipe.ingredients', index - 1, 0, temp);
                },
                move_direction_up: function(e) {
                    var index = Number(
                            e.currentTarget.attributes['data-index'].value);
                    if (!index) return;
                    var temp = this.splice('recipe.directions', index, 1)[0];
                    this.splice('recipe.directions', index - 1, 0, temp);
                },
                format_recipe_tags: function(tags) {
                    if (!tags) return "";
                    return tags.join(", ");
                },
                add_one: function(val) {
                    return val + 1;
                },
            });
        })();
    </script>
</dom-module>
